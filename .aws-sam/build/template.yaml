AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: True Profit MVP - Backend & Pipeline
Globals:
  Function:
    Runtime: python3.9
    Timeout: 30
    MemorySize: 256
    Tags: {}
  Api:
    Cors:
      AllowMethods: '''GET,POST,OPTIONS'''
      AllowHeaders: '''content-type'''
      AllowOrigin: '''*'''
Resources:
  TransactionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: Transactions
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: transaction_id
        AttributeType: S
      KeySchema:
      - AttributeName: transaction_id
        KeyType: HASH
  MerchantsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: Merchants
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: merchant_id
        AttributeType: S
      KeySchema:
      - AttributeName: merchant_id
        KeyType: HASH
  DailyMetricsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: DailyMetrics
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: merchant_id
        AttributeType: S
      - AttributeName: date
        AttributeType: S
      KeySchema:
      - AttributeName: merchant_id
        KeyType: HASH
      - AttributeName: date
        KeyType: RANGE
  MarketingSpendTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: MarketingSpend
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: merchant_id
        AttributeType: S
      - AttributeName: date
        AttributeType: S
      KeySchema:
      - AttributeName: merchant_id
        KeyType: HASH
      - AttributeName: date
        KeyType: RANGE
  DeadLetterQueue:
    Type: AWS::SQS::Queue
  IngestionQueue:
    Type: AWS::SQS::Queue
    Properties:
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - DeadLetterQueue
          - Arn
        maxReceiveCount: 3
  DeadLetterQueueAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      Namespace: AWS/SQS
      MetricName: ApproximateNumberOfMessagesVisible
      Dimensions:
      - Name: QueueName
        Value:
          Fn::GetAtt:
          - DeadLetterQueue
          - QueueName
      Statistic: Sum
      Period: 60
      EvaluationPeriods: 1
      Threshold: 3
      ComparisonOperator: GreaterThanThreshold
      AlarmActions:
      - Ref: AlertTopic
  HighProfitAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: Profit is higher than normal (> 120)
      MetricName: Profit
      Namespace: TrueProfit/Metrics
      ComparisonOperator: GreaterThanThreshold
      Threshold: 120
      EvaluationPeriods: 1
      Period: 60
      Statistic: Sum
      TreatMissingData: notBreaching
      AlarmActions:
      - Ref: AlertTopic
  ExportBucket:
    Type: AWS::S3::Bucket
  AlertTopic:
    Type: AWS::SNS::Topic
  EmailSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      TopicArn:
        Ref: AlertTopic
      Protocol: email
      Endpoint: trongtbh145@gmail.com
  IngestFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: IngestFunction
      Handler: handler.lambda_handler
      Role:
        Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/LabRole
      Environment:
        Variables:
          QUEUE_URL:
            Ref: IngestionQueue
      Events:
        IngestApi:
          Type: Api
          Properties:
            Path: /ingest/transaction
            Method: POST
    Metadata:
      SamResourceId: IngestFunction
  QueryMetricsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: QueryMetricsFunction
      Handler: handler.lambda_handler
      Role:
        Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/LabRole
      Environment:
        Variables:
          DAILY_METRICS_TABLE:
            Ref: DailyMetricsTable
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: DailyMetricsTable
      Events:
        GetMetrics:
          Type: Api
          Properties:
            Path: /metrics
            Method: GET
    Metadata:
      SamResourceId: QueryMetricsFunction
  ProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ProcessorFunction
      Handler: handler.lambda_handler
      Role:
        Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/LabRole
      Environment:
        Variables:
          TRANSACTIONS_TABLE:
            Ref: TransactionsTable
          DAILY_METRICS_TABLE:
            Ref: DailyMetricsTable
          EXPORT_BUCKET:
            Ref: ExportBucket
      Events:
        SQSTrigger:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - IngestionQueue
              - Arn
            BatchSize: 10
    Metadata:
      SamResourceId: ProcessorFunction
  ExportFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ExportFunction
      Handler: handler.handler
      Role:
        Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/LabRole
      Environment:
        Variables:
          DAILY_METRICS_TABLE:
            Ref: DailyMetricsTable
          EXPORT_BUCKET:
            Ref: ExportBucket
      Events:
        ExportApi:
          Type: Api
          Properties:
            Path: /export
            Method: POST
        ScheduledExport:
          Type: Schedule
          Properties:
            Schedule: rate(5 minutes)
            Enabled: true
    Metadata:
      SamResourceId: ExportFunction
  GetStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: GetStatusFunction
      Handler: handler.lambda_handler
      Runtime: python3.9
      Role:
        Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/LabRole
      Policies:
      - CloudWatchReadOnlyAccess
      Environment:
        Variables:
          ALARM_NAME:
            Ref: HighProfitAlarm
      Events:
        GetStatusApi:
          Type: Api
          Properties:
            Path: /anomaly/status
            Method: GET
    Metadata:
      SamResourceId: GetStatusFunction
Outputs:
  ApiEndpoint:
    Description: API Gateway endpoint URL
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/
  IngestTransactionEndpoint:
    Description: Ingest transaction endpoint URL
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/ingest/transaction
  IngestionQueueUrl:
    Description: SQS Queue URL
    Value:
      Ref: IngestionQueue
