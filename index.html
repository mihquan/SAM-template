<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrueProfit MVP - Sprint 5 (Monitoring)</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; background-color: #f4f4f4; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2, h3 { text-align: center; color: #333; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input, select { width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        
        button { margin-top: 15px; width: 100%; padding: 10px; cursor: pointer; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; }
        .btn-send { background: #007bff; color: white; }
        .btn-send:hover { background: #0056b3; }
        
        .btn-check { background: #6c757d; color: white; margin-top: 5px; }
        .btn-check:hover { background: #5a6268; }

        .result { margin-top: 20px; padding: 10px; background: #222; color: #0f0; border-radius: 4px; white-space: pre-wrap; min-height: 50px; font-family: monospace; }
        .config-box { background: #fff3e0; border: 1px solid #ffb74d; padding: 10px; border-radius: 4px; margin-bottom: 20px; }

        /* NEW CSS FOR THE STATUS SECTION */
        .status-box { margin-bottom: 20px; padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; transition: all 0.3s; font-size: 18px; }
        .status-ok { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-danger { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; animation: pulse 2s infinite; }
        .status-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>üöÄ TrueProfit Dashboard</h1>

        <div class="config-box">
            <label>üîó API Gateway URL (Copy from SAM Output):</label>
            <input type="text" id="apiUrl" placeholder="https://xxxx.execute-api.us-east-1.amazonaws.com/Prod">
        </div>

        <div class="card">
            <h2>üì° System Status (Monitoring)</h2>
            <div id="systemStatus" class="status-box status-warning">
                ‚è≥ Loading data...
            </div>
            <button class="btn-check" onclick="checkSystemStatus()">üîÑ Refresh status</button>
        </div>
        <hr style="margin: 20px 0;">

        <h2>üìù Enter Transaction (Ingest)</h2>
        
        <label>Merchant ID: 
            <select id="merchantId">
                <option value="SHOP_A">üõí Shop A (Fashion)</option>
                <option value="SHOP_B">üçî Shop B (Food)</option>
                <option value="SHOP_C">üì± Shop C (Electronics)</option>
            </select>
        </label>

        <label>Transaction ID: <input type="text" id="txnId" value="TXN_001"></label>
        <label>Revenue ($): <input type="number" id="revenue" value="100"></label>
        <label>Cost ($): <input type="number" id="cost" value="60"></label>
        <label>Ad Spend ($): <input type="number" id="adSpend" value="10"></label>
        <label>Fees ($): <input type="number" id="fees" value="5"></label>
        
        <button class="btn-send" onclick="sendTransaction()">üì§ Send Transaction</button>

        <h3>üì° Server Response:</h3>
        <div id="result" class="result">Waiting...</div>
    </div>

    <script>
        function getApiUrl() {
            let url = document.getElementById('apiUrl').value.trim();
            if (url.endsWith('/')) url = url.slice(0, -1);
            return url;
        }

        // --- NEW FUNCTION: CHECK ALARM STATUS ---
        async function checkSystemStatus() {
            const baseUrl = getApiUrl();
            if (!baseUrl) return alert("Please enter the API URL first!");

            const statusBox = document.getElementById('systemStatus');
            statusBox.innerText = "‚è≥ Checking...";
            statusBox.className = "status-box status-warning";

            try {
                // Call API GET /anomaly/status
                const res = await fetch(`${baseUrl}/anomaly/status`);
                const data = await res.json();

                if (data.status === 'OK') {
                    statusBox.className = "status-box status-ok";
                    statusBox.innerHTML = "‚úÖ " + data.message;
                } else if (data.status === 'DANGER') {
                    statusBox.className = "status-box status-danger";
                    statusBox.innerHTML = "üö® " + data.message;
                } else {
                    statusBox.className = "status-box status-warning";
                    statusBox.innerHTML = "‚ö†Ô∏è " + data.message;
                }
            } catch (err) {
                statusBox.innerText = "‚ùå Connection error: " + err.message;
            }
        }

        // --- EXISTING FUNCTION: SEND TRANSACTION ---
        async function sendTransaction() {
            const baseUrl = getApiUrl();
            if (!baseUrl) return alert("Please enter the API URL first!");

            // üëá PH·∫¶N N√ÄY L√Ä PH·∫¶N B·∫†N B·ªä THI·∫æU ·ªû FILE C≈® üëá
            const randomId = "TXN_" + Math.floor(Math.random() * 10000);
            document.getElementById('txnId').value = randomId;

            const payload = {
                transaction_id: randomId,
                merchant_id: document.getElementById('merchantId').value,
                date: new Date().toISOString().split('T')[0],
                revenue: parseFloat(document.getElementById('revenue').value),
                cost: parseFloat(document.getElementById('cost').value),
                ad_spend: parseFloat(document.getElementById('adSpend').value),
                fees: parseFloat(document.getElementById('fees').value)
            };

            document.getElementById('result').innerText = "Sending data...";

            try {
                const res = await fetch(`${baseUrl}/ingest/transaction`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await res.json();
                document.getElementById('result').innerText = "‚úÖ Success:\n" + JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('result').innerText = "‚ùå Error:\n" + error.message;
            }
        }

        // Auto check status on load
        setTimeout(() => {
            if(document.getElementById('apiUrl').value) checkSystemStatus();
        }, 1000);

    </script>
</body>
</html>